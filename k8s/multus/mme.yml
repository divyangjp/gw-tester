---
# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2020
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

apiVersion: v1
kind: Pod
metadata:
  name: mme
  annotations:
    k8s.v1.cni.cncf.io/networks: '[
      { "name": "lte-s11", "interface": "net1" },
      { "name": "lte-s1c", "interface": "net2" }
    ]'
spec:
  restartPolicy: OnFailure
  containers:
  - image: electrocucaracha/mme
    name: mme
    command:
      - "sh"
    args:
      - "/opt/gw-tester/script/init.sh"
    volumeMounts:
      - name: init-script
        mountPath: /opt/gw-tester/script
  volumes:
    - name: init-script
      configMap:
        name: mme-init-script
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mme-init-script
data:
  init.sh: |
    s11_ip=$(ifconfig net1 | awk '/inet addr/{print substr($2,6)}')
    s1c_ip=$(ifconfig net2 | awk '/inet addr/{print substr($2,6)}')

    sed -i "s|s11_ip:.*|s11_ip: \"${s11_ip}\"|g" /etc/gw-tester/mme.yml
    sed -i "s|s1c_addr:.*|s1c_addr: \"${s1c_ip}:36412\"|g" /etc/gw-tester/mme.yml

    sed -i "s|sgw_s11_ip:.*|sgw_s11_ip: \"$SGW_S11_IP\"|g" /etc/gw-tester/mme.yml
    sed -i "s|pgw_s5c_ip:.*|pgw_s5c_ip: \"$PGW_S5C_IP\"|g" /etc/gw-tester/mme.yml

    /opt/gw-tester/bin/mme -config /etc/gw-tester/mme.yml
